name: Generate Sitemap & Inject Secrets

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '16'

      # ── Inject Supabase secrets into index.html ────────────────────────────
      - name: Inject Supabase credentials
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          sed -i "s|%%SUPABASE_URL%%|${SUPABASE_URL}|g" index.html
          sed -i "s|%%SUPABASE_ANON_KEY%%|${SUPABASE_ANON_KEY}|g" index.html
          echo "✅ Supabase credentials injected into index.html"

      # ── Generate sitemap ───────────────────────────────────────────────────
      - name: Create sitemap generation script
        run: |
          cat > generate-sitemap.js <<'EOL'
          const fs = require('fs');
          const path = require('path');

          // Configuration
          const BASE_URL = 'https://crawl-data.com/';
          const CONTENT_DIR = './';
          const FILE_EXTENSIONS = ['.html', '.md', '.txt'];
          const EXCLUDED_DIRS = ['.git', 'node_modules', '.github'];

          function walkSync(dir, fileList = []) {
            if (!fs.existsSync(dir)) return fileList;
            const files = fs.readdirSync(dir);
            files.forEach(file => {
              const filePath = path.join(dir, file);
              try {
                const stat = fs.statSync(filePath);
                if (stat.isDirectory() && !EXCLUDED_DIRS.includes(file)) {
                  fileList = walkSync(filePath, fileList);
                } else if (stat.isFile() && FILE_EXTENSIONS.some(ext => file.endsWith(ext))) {
                  let urlPath = path.relative(CONTENT_DIR, filePath);
                  urlPath = urlPath.split(path.sep).join('/');
                  const fullUrl = BASE_URL + urlPath;
                  fileList.push({ url: fullUrl, lastmod: new Date().toISOString().split('T')[0] });
                }
              } catch (error) {
                console.error(`Error processing ${filePath}:`, error.message);
              }
            });
            return fileList;
          }

          function generateSitemap(urls) {
            let sitemap = '<?xml version="1.0" encoding="UTF-8"?>\n';
            sitemap += '<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">\n';
            urls.forEach(item => {
              sitemap += '  <url>\n';
              sitemap += `    <loc>${item.url}</loc>\n`;
              sitemap += `    <lastmod>${item.lastmod}</lastmod>\n`;
              sitemap += '  </url>\n';
            });
            sitemap += '</urlset>';
            return sitemap;
          }

          try {
            console.log('Generating sitemap...');
            const urls = walkSync(CONTENT_DIR);
            const sitemap = generateSitemap(urls);
            fs.writeFileSync('sitemap.xml', sitemap);
            console.log(`Sitemap generated with ${urls.length} URLs.`);
            urls.forEach(item => console.log(` - ${item.url}`));
          } catch (error) {
            console.error('Error:', error);
            process.exit(1);
          }
          EOL

      - name: Generate sitemap
        run: node generate-sitemap.js

      # ── Commit everything back ─────────────────────────────────────────────
      - name: Commit and push changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add sitemap.xml index.html
          git commit -m "ci: inject secrets & update sitemap [skip ci]" || echo "No changes to commit"
          git push
